<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHYLOPROBE | Senior Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* DETERMINISTIC LAYOUT CONSTANTS */
        :root {
            --node-w: 340px;
            --node-h: 240px;
            --branch-gap: 160px;
        }

        .node-card { 
            width: var(--node-w);
            height: var(--node-h);
            background: white;
            border: 5px solid #e2e8f0;
            border-radius: 40px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20;
            position: relative;
        }

        .node-card.active { 
            border-color: #2563eb; 
            box-shadow: 0 30px 60px -12px rgba(37, 99, 235, 0.3);
            transform: scale(1.08);
        }

        /* THE BRANCH ENGINE: Pixel-Perfect Anchoring */
        .branch-container {
            position: absolute;
            left: calc(var(--branch-gap) * -1);
            width: var(--branch-gap);
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
        }

        .branch-path {
            stroke: #cbd5e1;
            stroke-width: 6;
            fill: none;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        .node-card.active .branch-path { stroke: #2563eb; }

        /* SCROLLBARS */
        .scroll-custom::-webkit-scrollbar { width: 12px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [domain, setDomain] = useState('social');
            const [data, setData] = useState(null);
            const [timeIndex, setTimeIndex] = useState(10);
            const [selectedNode, setSelectedNode] = useState(null);
            const [zoom, setZoom] = useState(0.8);
            const [viewMode, setViewMode] = useState('tree');

            const hydrate = (node) => {
                node.history = {
                    a: Array.from({length: 21}, () => 20 + Math.random() * 80),
                    b: Array.from({length: 21}, () => 10 + Math.random() * 70),
                    c: Array.from({length: 21}, () => Math.random() * 100),
                    grids: Array.from({length: 21}, () => Array.from({length: 25}, () => Math.random() > 0.7))
                };
                if (node.children) node.children.forEach(hydrate);
                return node;
            };

            useEffect(() => {
                fetch(`./${domain}.json`)
                    .then(res => res.json())
                    .then(json => {
                        const full = { ...json, tree: hydrate(json.tree) };
                        setData(full);
                        setSelectedNode(full.tree);
                    });
            }, [domain]);

            if (!data) return <div className="h-screen grid place-items-center text-5xl font-black text-slate-300">BOOTING SYSTEM...</div>;

            return (
                <div className="flex h-screen w-full">
                    {/* COMMAND SIDEBAR */}
                    <aside className="w-[550px] bg-slate-900 text-white p-12 flex flex-col gap-10 z-50 shadow-2xl">
                        <header>
                            <h1 className="text-7xl font-black text-blue-500 italic tracking-tighter">PHYLOPROBE</h1>
                            <p className="text-sm font-bold text-slate-500 uppercase tracking-[0.5em] mt-3">Temporal Hierarchy Engine</p>
                        </header>

                        <div className="p-8 bg-slate-800/50 rounded-[40px] border border-slate-700/50">
                            <h3 className="text-2xl font-black text-blue-300 uppercase mb-4 tracking-widest">Operator Instructions</h3>
                            <ul className="text-2xl text-slate-300 space-y-6 leading-snug">
                                <li><b className="text-white">Select:</b> Click node cards to bind data.</li>
                                <li><b className="text-white">Scrub:</b> Drag the bottom T-bar to travel through 20 intervals of history.</li>
                                <li><b className="text-white">Observe:</b> Note the 5x5 grid shift as the "Internal DNA" of the node updates.</li>
                            </ul>
                        </div>

                        <div className="space-y-4">
                            {['social', 'finance', 'software'].map(id => (
                                <button key={id} onClick={() => setDomain(id)}
                                    className={`w-full text-left p-8 rounded-[35px] font-black text-3xl capitalize transition-all ${domain === id ? 'bg-blue-600 shadow-2xl scale-105' : 'bg-slate-800 text-slate-500 hover:text-white'}`}>
                                    {id} Mode
                                </button>
                            ))}
                        </div>

                        <button 
                            onClick={() => setViewMode(viewMode === 'tree' ? 'list' : 'tree')}
                            className="mt-auto py-8 bg-white text-slate-900 font-black text-2xl rounded-[35px] hover:bg-blue-50 transition-all shadow-xl uppercase"
                        >
                            Switch to {viewMode === 'tree' ? 'Comparative List' : 'Hierarchy Tree'}
                        </button>
                    </aside>

                    {/* VIEWPORT */}
                    <main className="flex-grow flex flex-col relative bg-slate-50 overflow-hidden">
                        <header className="h-32 bg-white border-b flex items-center px-16 justify-between z-40">
                            <h2 className="text-5xl font-black text-slate-800 tracking-tighter uppercase">{data.method}</h2>
                            <div className="flex items-center gap-6 bg-slate-100 p-3 rounded-3xl border shadow-inner">
                                <button onClick={() => setZoom(z => Math.max(0.4, z-0.1))} className="w-14 h-14 text-4xl font-bold hover:bg-white rounded-2xl transition-all">-</button>
                                <span className="text-2xl font-black mono w-20 text-center">{Math.round(zoom * 100)}%</span>
                                <button onClick={() => setZoom(z => Math.min(1.5, z+0.1))} className="w-14 h-14 text-4xl font-bold hover:bg-white rounded-2xl transition-all">+</button>
                            </div>
                        </header>

                        <div className="flex-grow overflow-auto scroll-custom p-32">
                            <div className="relative origin-top-left" style={{ transform: `scale(${zoom})` }}>
                                {viewMode === 'tree' ? (
                                    <TreeRenderer node={data.tree} onSelect={setSelectedNode} selectedId={selectedNode?.id} timeIndex={timeIndex} />
                                ) : (
                                    <div className="max-w-6xl mx-auto space-y-10">
                                        <FlatList node={data.tree} onSelect={setSelectedNode} selectedId={selectedNode?.id} timeIndex={timeIndex} />
                                    </div>
                                )}
                            </div>
                        </div>

                        <footer className="h-56 border-t bg-white px-20 flex items-center gap-20 z-40 shadow-[0_-30px_60px_rgba(0,0,0,0.05)]">
                            <div className="flex flex-col min-w-[220px]">
                                <span className="text-lg font-black text-slate-400 uppercase tracking-widest">Temporal Index</span>
                                <span className="text-9xl font-black mono text-blue-600 leading-none">T-{timeIndex}</span>
                            </div>
                            <input type="range" min="0" max="20" value={timeIndex} 
                                onChange={(e) => setTimeIndex(parseInt(e.target.value))}
                                className="flex-grow h-6 bg-slate-200 rounded-full appearance-none cursor-pointer accent-blue-600" />
                        </footer>
                    </main>

                    {/* INSPECTOR */}
                    <aside className="w-[650px] bg-white border-l p-16 flex flex-col gap-12 z-50 shadow-2xl overflow-y-auto scroll-custom">
                        <header>
                            <h2 className="text-7xl font-black tracking-tighter text-slate-900 mb-2">Inspector</h2>
                            <div className="inline-block px-5 py-2 bg-blue-100 text-blue-700 rounded-2xl font-black text-xl uppercase tracking-widest">
                                Node: {selectedNode?.label}
                            </div>
                        </header>

                        <section className="space-y-8">
                            <div className="flex justify-between items-end">
                                <label className="text-xl font-black text-slate-400 uppercase tracking-widest">State Snapshot Matrix</label>
                                <span className="mono text-lg font-bold text-blue-500">25-POINT CORE</span>
                            </div>
                            <div className="grid grid-cols-5 gap-5 aspect-square bg-slate-50 p-10 rounded-[60px] border-8 border-slate-100 shadow-inner">
                                {selectedNode?.history.grids[timeIndex].map((active, i) => (
                                    <div key={i} className={`rounded-3xl transition-all duration-300 ${active ? 'bg-indigo-600 shadow-xl scale-110' : 'bg-white border-4 border-slate-200'}`} />
                                ))}
                            </div>
                            <p className="text-2xl text-slate-500 font-medium leading-relaxed italic border-l-8 border-slate-100 pl-8">
                                This matrix visualizes the functional density of the selected node. Active subsystems are represented by the indigo cells.
                            </p>
                        </section>

                        <div className="space-y-12">
                            <MetricBar label={data.metrics.b} val={selectedNode?.history.b[timeIndex]} color="bg-red-500" unit="%" />
                            <MetricBar label={data.metrics.c} val={selectedNode?.history.c[timeIndex]} color="bg-blue-600" unit={data.metrics.unit} />
                            <MetricBar label={data.metrics.a} val={selectedNode?.history.a[timeIndex]} color="bg-green-500" unit="ops" />
                        </div>
                    </aside>
                </div>
            );
        };

        const MetricBar = ({ label, val, color, unit }) => (
            <div className="space-y-5">
                <div className="flex justify-between text-2xl font-black uppercase tracking-widest">
                    <span className="text-slate-400">{label}</span>
                    <span className={color.replace('bg-', 'text-')}>{Math.round(val)} {unit}</span>
                </div>
                <div className="h-8 bg-slate-100 rounded-full overflow-hidden border-4 border-slate-200/50 shadow-inner">
                    <div className={`${color} h-full transition-all duration-1000 cubic-bezier(0.23, 1, 0.32, 1)`} style={{width: `${val}%`}} />
                </div>
            </div>
        );

        const Sparkline = ({ history, timeIndex, width = 280 }) => {
            const points = (arr) => arr.map((v, i) => `${(i/20)*width},${70 - (v/100)*70}`).join(' ');
            return (
                <div className="bg-slate-50 rounded-[30px] p-5 mt-6 border-2 border-slate-100">
                    <svg width={width} height="70" className="overflow-visible">
                        <polyline points={points(history.c)} fill="none" stroke="#2563eb" strokeWidth="3" opacity="0.2" />
                        <polyline points={points(history.a)} fill="none" stroke="#22c55e" strokeWidth="4" strokeDasharray="8,4" />
                        <polyline points={points(history.b)} fill="none" stroke="#ef4444" strokeWidth="5" strokeLinecap="round" />
                        <line x1={(timeIndex/20)*width} y1="-10" x2={(timeIndex/20)*width} y2="80" stroke="#000" strokeWidth="4" strokeDasharray="10,5" />
                    </svg>
                </div>
            );
        };

        const TreeRenderer = ({ node, onSelect, selectedId, timeIndex }) => (
            <div className="flex items-center relative">
                {/* PIXEL-PERFECT NODE */}
                <div onClick={() => onSelect(node)}
                    className={`node-card p-10 flex flex-col justify-center ${selectedId === node.id ? 'active' : ''}`}>
                    <div className="text-sm font-black text-slate-400 uppercase tracking-widest mb-1">{node.id}</div>
                    <div className="text-4xl font-black text-slate-800 tracking-tighter truncate leading-none mb-2">{node.label}</div>
                    <Sparkline history={node.history} timeIndex={timeIndex} />
                </div>

                {/* CHILD CONTAINER */}
                {node.children && node.children.length > 0 && (
                    <div className="flex flex-col gap-48 ml-[160px] relative">
                        {node.children.map((child, idx) => {
                            // Calculating vertical center-to-center offset
                            const totalChildren = node.children.length;
                            const spacing = 240 + 192; // Node Height + Gap
                            const totalHeight = totalChildren * spacing - 192;
                            const midpoint = totalHeight / 2;
                            const currentPos = idx * spacing + 120;
                            const curveY = currentPos - midpoint;

                            return (
                                <div key={child.id} className="relative flex items-center">
                                    {/* BRANCH BRIDGE: Anchored to Midpoints */}
                                    <div className="branch-container">
                                        <svg width="160" height="600" className="overflow-visible">
                                            <path 
                                                d={`M 0,${300 - curveY} C 80,${300 - curveY} 80,300 160,300`} 
                                                className="branch-path"
                                            />
                                        </svg>
                                    </div>
                                    <TreeRenderer node={child} onSelect={onSelect} selectedId={selectedId} timeIndex={timeIndex} />
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        );

        const FlatList = ({ node, onSelect, selectedId, timeIndex }) => {
            const list = [];
            const walk = (n) => { list.push(n); if (n.children) n.children.forEach(walk); };
            walk(node);
            return list.map(n => (
                <div key={n.id} onClick={() => onSelect(n)}
                    className={`flex items-center gap-16 p-12 bg-white rounded-[50px] border-8 transition-all cursor-pointer shadow-lg ${selectedId === n.id ? 'border-blue-600 scale-[1.02]' : 'border-slate-100 hover:border-slate-200'}`}>
                    <div className="w-[400px] font-black text-5xl text-slate-800 tracking-tighter">{n.label}</div>
                    <div className="flex-grow"><Sparkline history={n.history} timeIndex={timeIndex} width={800} /></div>
                </div>
            ));
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
